import fs from 'fs/promises';
import path from 'path';

/** –ñ–æ—Ä—Å—Ç–∫–∏–π –ª—ñ–º—ñ—Ç —Å–∏–º–≤–æ–ª—ñ–≤ –∑ –∑–∞–ø–∞—Å–æ–º –¥–ª—è Threads */
export const MAX_CHARS = 420;

/** –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ (—Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑—ñ —Å—Ç–∞—Ä–∏–º–∏ —á–∞—Å—Ç–∏–Ω–∞–º–∏) */
const COUNTERS_PATH = path.resolve('data/counters.json');

async function ensureCountersFile() {
    try { await fs.mkdir(path.dirname(COUNTERS_PATH), { recursive: true }); } catch { }
    try { await fs.access(COUNTERS_PATH); } catch {
        await fs.writeFile(COUNTERS_PATH, JSON.stringify({ tip: 0 }, null, 2), 'utf8');
    }
}

export async function nextDayCounter(key = 'tip') {
    await ensureCountersFile();
    const raw = await fs.readFile(COUNTERS_PATH, 'utf8').catch(() => '{ "tip": 0 }');
    const obj = JSON.parse(raw || '{}');
    obj[key] = (obj[key] || 0) + 1;
    await fs.writeFile(COUNTERS_PATH, JSON.stringify(obj, null, 2), 'utf8');
    return obj[key];
}

/** –°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä –ø–æ—Ä–∞–¥: —Å—Ç–∞—Ä—Ç –≤—ñ–¥ 01.09.2025 ‚Üí ‚Ññ1 —É —Ü–µ–π –¥–µ–Ω—å */
export function tipSerialNumber(dateInput = new Date()) {
    const startUTC = Date.UTC(2025, 8, 1); // 8 = –≤–µ—Ä–µ—Å–µ–Ω—å (0-–±–∞–∑–æ–≤–∞–Ω–∏–π)
    const d = new Date(dateInput);
    const todayUTC = Date.UTC(d.getFullYear(), d.getMonth(), d.getDate());
    const diff = Math.floor((todayUTC - startUTC) / 86400000) + 1;
    return Math.max(1, diff);
}

/** –¢–µ–º–∏ –¥–ª—è story/tip (–Ω–µ–Ω–∞–≤ º—è–∑–ª–∏–≤—ñ –ø—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è –º–æ–¥–µ–ª—ñ) */
const STORY_THEMES = [
    '–º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏', '–Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω–∏–π –ø—Ä–æ–≤–∞–ª —ñ –≤–∏—Å–Ω–æ–≤–∫–∏', '–∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π —Å–µ—Ä–≤—ñ—Å',
    '—Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è', '–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è', '–ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∏', '–ø–æ–º–∏–ª–∫–∏ —Ñ–∞—É–Ω–¥–µ—Ä–∞', '–º–∞—Ä–∫–µ—Ç–∏–Ω–≥-–µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç',
    '–≤–∑–∞—î–º–æ–¥—ñ—è –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏', '–≤–∑–∞—î–º–æ–¥—ñ—è –∑ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞–º–∏', '–≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏'
];

const TIP_THEMES = [
    '–¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è', '–ø—Ä—ñ–æ—Ä–∏—Ç–∏–∑–∞—Ü—ñ—è', '—Ä–µ–ª—ñ–∑-–ø—Ä–æ—Ü–µ—Å', '–∞–Ω–∞–ª—ñ—Ç–∏–∫–∞', '–≤–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂—ñ–≤',
    '–∫–∞–¥—Ä–æ–≤—ñ –ø—Ä–æ—Ü–µ—Å–∏', '–∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –≤ –∫–æ–º–∞–Ω–¥—ñ', '–∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π –¥–æ—Å–≤—ñ–¥', '—é–Ω—ñ—Ç-–µ–∫–æ–Ω–æ–º—ñ–∫–∞'
];

const NEWS_SOURCES = [
    '–ï–∫–æ–Ω–æ–º—ñ—á–Ω–∞ –ø—Ä–∞–≤–¥–∞', 'Forbes –£–∫—Ä–∞—ó–Ω–∞', '–ù–í –ë—ñ–∑–Ω–µ—Å', 'Liga.–ë—ñ–∑–Ω–µ—Å',
    '–ú—ñ–Ω—Ñ—ñ–Ω', 'AIN.UA', 'dev.ua', 'DOU'
];

/** –ü–æ–±—É–¥–æ–≤–∞ –ø—Ä–æ–º–ø—Ç–∞ –ø—ñ–¥ —Ç–∏–ø –ø–æ—Å—Ç—É */
export function buildPromptForType(type = 'story', { day } = {}) {
    if (type === 'story') {
        return [
            '–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫—É –º—ñ–Ω—ñ-—ñ—Å—Ç–æ—Ä—ñ—é –∑ –¥–æ—Å–≤—ñ–¥—É –ø—ñ–¥–ø—Ä–∏—î–º—Ü—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é.',
            '–°—Ç–∏–ª—å: –∂–∏–≤–æ, –ª—é–¥—è–Ω–æ, 2‚Äì3 –∞–±–∑–∞—Ü–∏ –±–µ–∑ –Ω–∞–∫–∞–∑—ñ–≤ —ñ –∫–ª—ñ—à–µ.',
            `–û–±–µ—Ä–∏ —Ç–µ–º—É –∑ –ø–µ—Ä–µ–ª—ñ–∫—É: ${STORY_THEMES.join(', ')}.`,
            `–õ—ñ–º—ñ—Ç ${MAX_CHARS} —Å–∏–º–≤–æ–ª—ñ–≤. –ë–µ–∑ —Ö–µ—à—Ç–µ–≥—ñ–≤ —ñ –µ–º–æ–¥–∑—ñ –Ω–∞ –ø–æ—á–∞—Ç–∫—É.`
        ].join(' ');
    }

    if (type === 'tip') {
        const n = typeof day === 'number' ? day : tipSerialNumber();
        return [
            `–ü–æ—á–Ω–∏ —Ä—ñ–≤–Ω–æ —Ç–∞–∫: "–ø–æ—Ä–∞–¥–∞ –≤—ñ–¥ –±—ñ–∑–Ω–µ—Å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ ‚Ññ${n} ‚Äî " (–Ω–∏–∂–Ω—ñ–π —Ä–µ–≥—ñ—Å—Ç—Ä).`,
            '–î–∞–π 1 –Ω–µ –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—É –ø–æ—Ä–∞–¥—É —É —Ñ–æ—Ä–º—ñ –∫–æ—Ä–æ—Ç–∫–æ—ó —Ä–æ–∑–ø–æ–≤—ñ–¥—ñ/–∑–∞–º—ñ—Ç–∫–∏ (–±–µ–∑ –Ω–∞–∫–∞–∑–æ–≤–∏—Ö —Ñ–æ—Ä–º).',
            '–î–æ–¥–∞–π 1 –ø—Ä–∏–∫–ª–∞–¥ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —ñ –∑–∞–≤–µ—Ä—à–∏ –º º—è–∫–∏–º –∑–∞–ø–∏—Ç–∞–Ω–Ω—è–º.',
            `–õ—ñ–º—ñ—Ç ${MAX_CHARS} —Å–∏–º–≤–æ–ª—ñ–≤. –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é. –ë–µ–∑ —Ö–µ—à—Ç–µ–≥—ñ–≤.`
        ].join(' ');
    }

    if (type === 'news') {
        return [
            '–°—Ç–∏—Å–ª–∞ —Ä–µ–∞–ª—å–Ω–∞ –Ω–æ–≤–∏–Ω–∞ –∑—ñ —Å–≤—ñ—Ç—É —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 48 –≥–æ–¥–∏–Ω + –ª–∞–∫–æ–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä.',
            `–î–∂–µ—Ä–µ–ª–∞ —Ç—ñ–ª—å–∫–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: ${NEWS_SOURCES.join(', ')} –∞–±–æ –æ—Ñ—ñ—Ü—ñ–π–Ω—ñ –ø—Ä–µ—Å—Ä–µ–ª—ñ–∑–∏).`,
            '–ù–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ —É –¥—É–∂–∫–∞—Ö –≤–∫–∞–∂–∏ –¥–∂–µ—Ä–µ–ª–æ —ñ –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ (–ù–∞–∑–≤–∞ –º–µ–¥—ñ–∞, –î–î.–ú–ú).',
            '–ë–µ–∑ URL-–ø–æ—Å–∏–ª–∞–Ω—å —Ç–∞ –≤–∏–≥–∞–¥–æ–∫. –Ø–∫—â–æ –Ω–µ–º–∞—î –≤–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ —É —Ñ–∞–∫—Ç–∞—Ö ‚Äî –ø–æ–≤–µ—Ä–Ω–∏ —Ä—ñ–≤–Ω–æ: NEED_SOURCE.',
            `–õ—ñ–º—ñ—Ç (–Ω–æ–≤–∏–Ω–∞+–∫–æ–º–µ–Ω—Ç–∞—Ä): ${MAX_CHARS} —Å–∏–º–≤–æ–ª—ñ–≤. –§–æ—Ä–º–∞—Ç –≤–∏–≤–æ–¥—É: –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç–æ–≤–∏–π –±–ª–æ–∫.`
        ].join(' ');
    }

    if (type === 'humor') {
        return [
            '–ö–æ—Ä–æ—Ç–∫–∏–π –±—ñ–∑–Ω–µ—Å-–≥—É–º–æ—Ä —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é: –º—ñ–Ω—ñ-—Å—Ü–µ–Ω–∞/–¥—ñ–∞–ª–æ–≥/–∫–∞–ª–∞–º–±—É—Ä, —ñ—Ä–æ–Ω—ñ—á–Ω–æ –∞–ª–µ –±–µ–∑ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç—ñ.',
            `1‚Äì3 –∫–æ—Ä–æ—Ç–∫—ñ –∞–±–∑–∞—Ü–∏, –¥–æ ${MAX_CHARS} —Å–∏–º–≤–æ–ª—ñ–≤.`,
            '–ù–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ ‚Äî –ª–µ–≥–∫–∏–π –≥–∞—á–æ–∫ –¥–ª—è –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ (—Ä–∏—Ç–æ—Ä–∏—á–Ω–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è —á–∏ —ñ—Ä–æ–Ω—ñ—á–Ω–∞ —Ä–µ–ø–ª—ñ–∫–∞).',
            '–ë–µ–∑ —Ö–µ—à—Ç–µ–≥—ñ–≤ —ñ –±–µ–∑ –æ–±—Ä–∞–∑.'
        ].join(' ');
    }

    return `–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –¥–æ ${MAX_CHARS} —Å–∏–º–≤–æ–ª—ñ–≤ –Ω–∞ –±—ñ–∑–Ω–µ—Å-—Ç–µ–º–∞—Ç–∏–∫—É.`;
}

/** –†–µ—Ç—Ä–∞–π-–ø—Ä–æ–º–ø—Ç –¥–ª—è news, —è–∫—â–æ –º–æ–¥–µ–ª—å –ø–æ–≤–µ—Ä–Ω—É–ª–∞ NEED_SOURCE */
export function buildPromptForNewsRetry() {
    return [
        '–û–±–µ—Ä–∏ –æ–¥–Ω—É —Å–≤—ñ–∂—É (‚â§48 –≥–æ–¥) –±—ñ–∑–Ω–µ—Å-–Ω–æ–≤–∏–Ω—É –∑ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –¥–∂–µ—Ä–µ–ª (–ï–∫–æ–Ω–æ–º—ñ—á–Ω–∞ –ø—Ä–∞–≤–¥–∞, Forbes –£–∫—Ä–∞—ó–Ω–∞, –ù–í –ë—ñ–∑–Ω–µ—Å, Liga.–ë—ñ–∑–Ω–µ—Å, –ú—ñ–Ω—Ñ—ñ–Ω, AIN.UA, dev.ua, DOU) —Ç–∞ —Å—Ç–∏—Å–Ω–∏ —ó—ó —É 2‚Äì3 —Ä–µ—á–µ–Ω–Ω—è.',
        '–î–æ–¥–∞–π 1 –∫–æ—Ä–æ—Ç–∫–∏–π –∞–≤—Ç–æ—Ä—Å—å–∫–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä.',
        '–£ –¥—É–∂–∫–∞—Ö –≤ –∫—ñ–Ω—Ü—ñ –æ–±–æ–≤ º—è–∑–∫–æ–≤–æ –≤–∫–∞–∂–∏ –¥–∂–µ—Ä–µ–ª–æ+–¥–∞—Ç—É (–Ω–∞–ø—Ä.: (Forbes –£–∫—Ä–∞—ó–Ω–∞, 29.09)).',
        '–ë–µ–∑ –ø–æ—Å–∏–ª–∞–Ω—å. –Ø–∫—â–æ –Ω–µ –≤–ø–µ–≤–Ω–µ–Ω–∏–π —É —Ñ–∞–∫—Ç–∞—Ö ‚Äî NEED_SOURCE.',
        `–î–æ–≤–∂–∏–Ω–∞: ‚â§ ${MAX_CHARS} —Å–∏–º–≤–æ–ª—ñ–≤.`
    ].join(' ');
}

/** –ö–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ –¥–ª—è —Ü—ñ–ª—å–æ–≤–æ—ó –∞—É–¥–∏—Ç–æ—Ä—ñ—ó */
export const ENTREPRENEUR_KEYWORDS = [
    '–ø—ñ–¥–ø—Ä–∏—î–º–µ—Ü—å', '–≤–ª–∞—Å–Ω–∏–∫', 'founder', 'entrepreneur', 'CEO', '–∫–µ—Ä—ñ–≤–Ω–∏–∫', '—Ñ–∞—É–Ω–¥–µ—Ä',
    '–≤–ª–∞—Å–Ω–∏–∫ –∫–æ–º–ø–∞–Ω—ñ—ó', '–∫–µ—Ä—É—é –±—ñ–∑–Ω–µ—Å–æ–º', '–∫–µ—Ä—É—é –∫–æ–º–ø–∞–Ω—ñ—î—é', '–º—ñ–π –±—ñ–∑–Ω–µ—Å', '–º—ñ–π –ø—Ä–æ—î–∫—Ç'
];

export const BUSINESS_SEARCH_KEYWORDS = [
    '–±—ñ–∑–Ω–µ—Å', '–∫–µ—Ä—É—é', '–º–æ—è –∫–æ–º–∞–Ω–¥–∞', '–º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è', '—Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–∞–∂—ñ–≤', '–≤–æ—Ä–æ–Ω–∫–∞', '–ø—Ä–æ—Ü–µ—Å–∏',
    '–æ—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞', '—é–Ω—ñ—Ç-–µ–∫–æ–Ω–æ–º—ñ–∫–∞', '–∫–∞—Å–æ–≤—ñ —Ä–æ–∑—Ä–∏–≤–∏', 'cashflow', '–º–∞—Ä–∂–∞', 'crm', '–æ–ø–µ—Ä–∞—Ü—ñ–π–∫–∞',
    '—Å—Ç—Ä–∞—Ç–µ–≥—ñ—è', '–Ω–∞–π–º', '–¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è', '–∫–µ—Ä—ñ–≤–Ω–∏–∫', '–≤–ª–∞—Å–Ω–∏–∫ –±—ñ–∑–Ω–µ—Å—É', '–ø—Ä–∏–±—É—Ç–æ–∫', '–º–∞—Ä–∫–µ—Ç–∏–Ω–≥', '—Ä—ñ—Å—Ç'
];

export const COMMENT_BANK = [
    '–¶—ñ–∫–∞–≤–∞ –¥—É–º–∫–∞ ‚Äî –¥—è–∫—É—é!', '–ö–æ—Ä–∏—Å–Ω–æ. –í–ø—Ä–æ–≤–∞–¥–∂—É –Ω–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ.', '–ü—ñ–¥—Ç—Ä–∏–º—É—é! –ì–∞—Ä–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥.',
    '–ö–æ—Ä–æ—Ç–∫–æ —ñ –ø–æ —Å—É—Ç—ñ üëå', '–Ñ –Ω–∞–¥ —á–∏–º –ø–æ–¥—É–º–∞—Ç–∏. –î—è–∫—É—é –∑–∞ —ñ–Ω—Å–∞–π—Ç.',
    '–¢–∞–∫! –ë–∞—á–∏–≤ –ø–æ–¥—ñ–±–Ω–µ —É —Å–≤–æ—ó—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤.', '–ö–ª–∞—Å–Ω–æ —Å—Ñ–æ—Ä–º—É–ª—å–æ–≤–∞–Ω–æ.', '–ó–≥–æ–¥–µ–Ω, —Ü–µ –ø—Ä–∞—Ü—é—î.',
    '–°–∏–ª—å–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥.', '–ê–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è –∫–æ–º–∞–Ω–¥ 5‚Äì30 –ª—é–¥–µ–π.'
];
